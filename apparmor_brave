#include <tunables/global>

/etc/profiles/per-user/*/bin/brave {
  #include <abstractions/base>
  
  # CRITICAL: bash needs execute permission as script interpreter
  /nix/store/*-bash-*/bin/bash rix,
  /nix/store/*-brave-*/bin/brave Px,
  /nix/store/*-brave-*/bin/.brave-wrapped rix,
  /nix/store/** rm,
  /etc/profiles/per-user/*/bin/brave r,
}

/nix/store/*-brave-*/bin/brave {
  #include <abstractions/base>
  #include <abstractions/fonts>
  #include <abstractions/X>
  #include <abstractions/freedesktop.org>
  #include <abstractions/audio>
  #include <abstractions/dbus-session-strict>
  #include <abstractions/nameservice>
  #include <abstractions/openssl>
  #include <abstractions/ssl_certs>
  
  userns,
  
  # Bash needs execute permission here too
  /nix/store/*-bash-*/bin/bash rix,
  /nix/store/*-coreutils-*/bin/** ix,
  /nix/store/*-xdg-utils-*/bin/* ix,
  /nix/store/*-dbus-*/bin/dbus-send ix,
  
  /nix/store/*-brave-*/bin/brave ix,
  /nix/store/*-brave-*/bin/.brave-wrapped rix,
  /nix/store/*-brave-*/opt/brave.com/brave/brave ix,
  /nix/store/*-brave-*/opt/brave.com/brave/brave-browser ix,
  /nix/store/*-brave-*/opt/brave.com/brave/chrome_crashpad_handler ix,
  /nix/store/*-brave-*/opt/brave.com/brave/chrome-sandbox Ux,
  
  /nix/store/*-brave-*/lib/brave/** rm,
  /nix/store/*-brave-*/share/brave/** r,
  /nix/store/*-brave-*/opt/brave.com/brave/*.so* rm,
  /nix/store/*-brave-*/opt/brave.com/brave/**.so* rm,
  
  /nix/store/*-glibc-*/lib/*.so* rm,
  /nix/store/*-gcc-*/lib/*.so* rm,
  /nix/store/** rm,
  
  owner @{HOME}/.config/BraveSoftware/ r,
  owner @{HOME}/.config/BraveSoftware/** rwkl,
  owner @{HOME}/.cache/BraveSoftware/** rwkl,
  owner @{HOME}/.config/dconf/user r,
  owner /run/user/*/dconf/user rw,
  
  owner @{HOME}/.config/BraveSoftware/Brave-Browser/WidevineCdm/**/*.so m,
  
  owner @{HOME}/Downloads/ r,
  owner @{HOME}/Downloads/** rw,
  owner @{HOME}/Documents/** r,
  owner @{HOME}/Pictures/** r,
  owner @{HOME}/.local/share/icons/** r,
 
    # NSS certificate database for client certificates
  owner @{HOME}/.pki/ r,
  owner @{HOME}/.pki/nssdb/ r,
  owner @{HOME}/.pki/nssdb/cert9.db rk,
  owner @{HOME}/.pki/nssdb/key4.db rk,
  owner @{HOME}/.pki/nssdb/pkcs11.txt r,

  owner /tmp/** rwkl,
  /tmp/ r,
  owner /dev/shm/** rwkl,
  /dev/shm/ r,
  
  /dev/tty rw,
  /dev/pts/* rw,
  
  /proc/ r,
  /proc/sys/kernel/yama/ptrace_scope r,
  /proc/sys/fs/inotify/max_user_watches r,
  /proc/sys/kernel/random/uuid r,
  /proc/*/stat r,
  /proc/*/statm r,
  /proc/*/status r,
  /proc/*/cmdline r,
  /proc/*/task/ r,
  /proc/*/task/** r,
  /proc/*/fd/ r,
  /proc/*/fd/** rwk,
  /proc/*/oom_score_adj w,
  /proc/*/setgroups w,
  /proc/*/uid_map w,
  /proc/*/gid_map w,
  
  /sys/devices/system/cpu/** r,
  /sys/devices/system/node/** r,
  /sys/devices/pci*/** r,
  /dev/dri/** rw,
  /sys/devices/pci*/drm/** r,
  
  /etc/mime.types r,
  /etc/nsswitch.conf r,
  /etc/resolv.conf r,
  /etc/hosts r,
  /etc/timezone r,
  
  network inet stream,
  network inet6 stream,
  network inet dgram,
  network inet6 dgram,
  network netlink raw,
  
  dbus send bus=session peer=(name=org.freedesktop.portal.Desktop),
  dbus receive bus=session peer=(name=org.freedesktop.portal.Desktop),
  
  deny @{HOME}/.ssh/** rw,
  deny @{HOME}/.gnupg/** rw,
  deny @{HOME}/.aws/** rw,
  deny @{HOME}/.kube/** rw,
  deny /root/** rw,
  deny /etc/shadow r,
  deny /etc/passwd w,
  deny /boot/** rw,
  deny /sys/kernel/debug/** rw,
  deny /proc/kcore r,
  deny /proc/kmem rw,
  
  capability sys_admin,
  capability sys_chroot,
  capability setgid,
  capability setuid,
}
