###########################################################################################################################
#                         HARDENED SQUID CONFIG — Maximum Speed + Privacy + Security                                    #
#                                                                                                                       #
#         OpenBSD Squid 7.x Hardened Template              | upload v. 2026-02-22  |                                    #
###########################################################################################################################
# SETUP INSTRUCTIONS                                                                                                    #
#                                                                                                                       #
# 1. Replace placeholder IPs/ports:                                                                                     #
#    - 7.7.7.7    → Your WireGuard / proxy listener IP                                                                 #
#    - 7.7.7.0/24 → Your WireGuard / LAN subnet                                                                        #
#    - 6666       → Your proxy listener port                                                                            #
#                                                                                                                       #
# 2. Adjust to your hardware:                                                                                           #
#    - workers        → match CPU cores (1-8)                                                                           #
#    - cache_mem      → 256 MB (low RAM) to 2 GB (high RAM)                                                            #
#    - max_filedescriptors → 4096 (small) to 8192+ (busy)                                                              #
#                                                                                                                       #
# 3. External hardening (REQUIRED for full DMT defense):                                                                #
#                                                                                                                       #
#    --- systemd-resolved (Linux clients) ---                                                                           #
#    /etc/systemd/resolved.conf:                                                                                        #
#      [Resolve]                                                                                                        #
#      Cache=no                                                                                                         #
#      DNSSEC=no                                                                                                        #
#    Then: systemctl restart systemd-resolved                                                                           #
#                                                                                                                       #
#    NixOS declarative:                                                                                                 #
#      services.resolved = {                                                                                            #
#        enable     = true;                                                                                             #
#        dnssec     = "false";                                                                                          #
#        dnsovertls = "false";                                                                                          #
#        domains    = [ "~." ];                                                                                         #
#        extraConfig = "Cache=no";                                                                                      #
#      };                                                                                                               #
#                                                                                                                       #
#    --- Browser DNS caches (zero them) ---                                                                             #
#    Brave / Chromium (NixOS):                                                                                          #
#      programs.chromium.extraOpts = {                                                                                  #
#        "BuiltInDnsClientEnabled" = false;                                                                             #
#      };                                                                                                               #
#    Chromium launch flag (non-NixOS):                                                                                  #
#      --host-resolver-cache-size=0                                                                                     #
#                                                                                                                       #
#    Firefox (user.js in profile directory):                                                                            #
#      user_pref("network.dnsCacheEntries", 0);                                                                        #
#      user_pref("network.dnsCacheExpiration", 0);                                                                      #
#    Find profile: ls ~/.mozilla/firefox/                                                                               #
#                                                                                                                       #
#    --- OpenBSD PF — DNS egress rate limit ---                                                                         #
#    Add table near top of /etc/pf.conf:                                                                                #
#      table <dns_flood> persist                                                                                        #
#                                                                                                                       #
#    Add BEFORE your final "pass out" catch-all:                                                                        #
#      # DMT DEFENSE — rate limit DNS queries from Squid                                                               #
#      # 50 queries/10 sec — evicting 2048 fqdncache entries takes ~7 min                                              #
#      # Normal browsing: 20-30 unique domains per page load                                                            #
#      pass out on vio0 proto udp from (vio0) to any port 53 \                                                         #
#          keep state (max-src-conn-rate 50/10, overload <dns_flood> flush global)                                      #
#      pass out on vio0 proto tcp from (vio0) to any port 53 \                                                         #
#          keep state (max-src-conn-rate 50/10, overload <dns_flood> flush global)                                      #
#                                                                                                                       #
#    Then: pfctl -f /etc/pf.conf                                                                                        #
#                                                                                                                       #
# 4. Directives removed (incompatible with Squid 7.x on OpenBSD):                                                      #
#    - allow_underscore_hostnames off  → doesn't exist (check_hostnames covers it)                                      #
#    - dns_v4_first on                 → obsolete (Squid handles internally)                                            #
#    - esi_parser off                  → obsolete (not compiled in)                                                     #
#    - http_access deny !Safe_proto    → breaks CONNECT tunnels                                                         #
#      (CONNECT !SSL_ports + !Safe_methods already covers this)                                                         #
#                                                                                                                       #
###########################################################################################################################

#################################################################
# CORE IDENTITY
#################################################################
http_port                7.7.7.7:6666
tcp_outgoing_address     7.7.7.7
visible_hostname         proxy.local

#################################################################
# PRIVACY — PROXY PRESENCE HIDING
#################################################################
via                      off
forwarded_for            delete
follow_x_forwarded_for   deny all
httpd_suppress_version_string on

#################################################################
# REQUEST SMUGGLING PREVENTION [SECURITY — CRITICAL]
#################################################################
# Reject requests where Host header doesn't match URL target
# Closes cache poisoning via Host mismatch
host_verify_strict on

# Strict HTTP parsing — reject malformed headers
# Parsing differences between proxy and backend are the #1 smuggling vector
relaxed_header_parser off

# Reject URIs with raw spaces — must use %20
# Spaces in URIs exploit parsing ambiguity between proxy and backend
uri_whitespace deny

# Validate hostname format — reject malformed hostnames
check_hostnames on

#################################################################
# DNS CONFIGURATION
#################################################################
# Use local resolver — privacy and speed
# On OpenBSD: typically 127.0.0.1 (unbound) or your local resolver
dns_nameservers          127.0.0.1
dns_defnames             off

#################################################################
# DNS CACHE TUNING [DMT DEFENSE]
#################################################################
# Reduced from 4096 — smaller cache = natural churn = noisier timing signal
# Makes DNS cache eviction attacks unreliable
fqdncache_size 2048

# Aggressive IP cache retention — reduces upstream lookups
ipcache_size 4096
ipcache_low 90
ipcache_high 95

# 2 hour TTL — attacker's reload phase can't distinguish
# "visited 5 seconds ago" from "cached 2 hours ago"
# Both return fast from fqdncache — no usable timing signal
# Tradeoff: longer = better DMT defense, shorter = better CDN rotation
positive_dns_ttl  2 hours
negative_dns_ttl  5 minutes
negative_ttl      30 seconds

#################################################################
# WORKER PROCESSES
#################################################################
# Match CPU cores — adjust to your system (1-8)
workers 4

#################################################################
# RAM-ONLY CACHING STRATEGY
#################################################################
# All caching in memory — zero disk writes for privacy
# Adjust cache_mem based on available RAM (256 MB – 2 GB typical)
cache_mem                     384 MB
maximum_object_size_in_memory 1 MB
maximum_object_size           0
minimum_object_size           0 KB
memory_cache_shared           on
memory_cache_mode             always
cache_replacement_policy      heap LFUDA
memory_replacement_policy     heap GDSF

collapsed_forwarding on

# Convert force-reloads (Ctrl+F5) to conditional If-Modified-Since
# Prevents cache poisoning via forced fresh fetches [CACHE POISONING PREVENTION]
reload_into_ims on

#################################################################
# CONNECTION OPTIMIZATION
#################################################################
# Increased from 2 — single-user proxy benefits from aggressive prefetch
pipeline_prefetch 10

client_persistent_connections  on
server_persistent_connections  on

#################################################################
# SYSTEM RESOURCES
#################################################################
max_filedescriptors 8192

#################################################################
# BUFFER CONFIGURATION [ATTACK SURFACE REDUCTION]
#################################################################
# Reduced — oversized headers/requests are common attack vectors
# 32 KB covers even the most cookie-heavy sites
client_request_buffer_max_size 256 KB
request_header_max_size 32 KB
reply_header_max_size 32 KB

#################################################################
# RESPONSE SIZE LIMIT [MEMORY EXHAUSTION PREVENTION]
#################################################################
# Prevents zip bombs and OOM — 2 GB covers any legitimate download
reply_body_max_size 2 GB

# Disable range from cache — prevents overlapping/fragmented range abuse
range_offset_limit 0

#################################################################
# ABORT OPTIMIZATION
#################################################################
quick_abort_min 0 KB
quick_abort_max 0 KB
quick_abort_pct 95
read_ahead_gap 64 KB

#################################################################
# HTTPS HANDLING
#################################################################
# Tunnel HTTPS without inspection — fast, privacy-preserving
# Cannot modify HTTPS headers without SSL bumping
on_unsupported_protocol tunnel all

#################################################################
# CONTENT PROCESSING RESTRICTIONS [SECURITY]
#################################################################
# Disable content adaptation — no reason on a forward proxy
adaptation_access deny all

#################################################################
# TRAFFIC PRIORITIZATION
#################################################################
acl interactive_mime rep_mime_type text/html
acl interactive_mime rep_mime_type application/json
acl interactive_mime rep_mime_type application/xml
acl interactive_mime rep_mime_type text/plain

# Set TOS bits for QoS (requires OS support)
tcp_outgoing_tos 0x28 interactive_mime

#################################################################
# ACCESS CONTROL LISTS
#################################################################
acl localnet     src 7.7.7.0/24
acl localhost    src 127.0.0.1/32
acl local_dests  dst 7.7.7.0/24
acl SSL_ports    port 443
acl Safe_ports   port 80 443

# OPTIONS removed — CORS preflight not needed at proxy level
# DMT paper uses CORS preflight (OPTIONS) as a measurement primitive
acl Safe_methods method GET HEAD POST CONNECT

always_direct    allow local_dests

#################################################################
# ACCESS RULES
#################################################################
# Order matters — deny dangerous first, then allow, then deny rest

# Block TRACE (XST — leaks cookies/auth) and PURGE (cache manipulation)
# MUST be before allow rules [CRITICAL]
acl dangerous_methods method TRACE PURGE
http_access deny dangerous_methods

http_access allow localhost
http_access allow localnet
http_access deny  !Safe_ports
http_access deny  CONNECT !SSL_ports
http_access deny  !Safe_methods
http_access deny  all

#################################################################
# CACHE MANAGER — DISABLE ALL QUERIES [SECURITY — CRITICAL]
#################################################################
# Without this, cache_object:// URLs leak internal state:
# DNS cache contents, memory usage, connection tables
# Effectively the DMT attack via Squid's own management interface
cache_mgr nobody
cachemgr_passwd disable all

#################################################################
# PRIVACY — REQUEST HEADER FILTERING
#################################################################

# IP Leak Prevention (CRITICAL)
request_header_access X-Forwarded-For           deny all
request_header_access X-Real-IP                 deny all
request_header_access X-Client-IP               deny all
request_header_access CF-Connecting-IP          deny all
request_header_access True-Client-IP            deny all
request_header_access Forwarded                 deny all
request_header_access X-Originating-IP          deny all
request_header_access X-Host                    deny all

# Client Hints Blocking (Anti-Fingerprinting)
request_header_access Accept-CH                 deny all
request_header_access Critical-CH               deny all
request_header_access Save-Data                 deny all
request_header_access Device-Memory             deny all
request_header_access Viewport-Width            deny all
request_header_access Downlink                  deny all
request_header_access RTT                       deny all
request_header_access ECT                       deny all

# User-Agent Client Hints (Chrome 89+)
request_header_access User-Agent-Full           deny all
request_header_access UA-Platform               deny all
request_header_access UA-Platform-Version       deny all
request_header_access UA-Mobile                 deny all
request_header_access UA-Model                  deny all
request_header_access UA-Arch                   deny all
request_header_access UA-Bitness                deny all
request_header_access UA-Full-Version           deny all
request_header_access UA-Full-Version-List      deny all
request_header_access Sec-CH-UA                 deny all
request_header_access Sec-CH-UA-Mobile          deny all
request_header_access Sec-CH-UA-Platform        deny all
request_header_access Sec-CH-UA-Full-Version-List deny all

# Tracking Vector Blocking
request_header_access Sec-GPC                   deny all
request_header_access Content-DPR               deny all
request_header_access DPR                       deny all
request_header_access Width                     deny all
request_header_access From                      deny all
request_header_access Proxy-Connection          deny all

# Privacy Signal Blocking
# DNT ironically makes you MORE trackable — strip it
request_header_access DNT                       deny all

# Carrier / ISP Tracking
request_header_access X-ATT-DeviceId            deny all
request_header_access X-UIDH                    deny all

# AJAX Fingerprinting
request_header_access X-Requested-With          deny all

# Allow everything else — User-Agent, Cookie, Referer needed for:
# - Normal website functionality (sessions, logins)
# - Bot detection bypass (blocking these triggers CAPTCHAs)
# - Cache validation (If-None-Match, Cache-Control)
request_header_access All allow all

#################################################################
# PRIVACY — RESPONSE HEADER FILTERING
#################################################################

# Server Identity Protection
reply_header_access Server                  deny all
reply_header_access X-Powered-By            deny all
reply_header_access X-AspNet-Version        deny all
reply_header_access X-AspNetMvc-Version     deny all

# Cache Infrastructure Hiding
reply_header_access X-Cache                 deny all
reply_header_access X-Cache-Lookup          deny all
reply_header_access X-Cache-Hits            deny all
reply_header_access Via                     deny all

# Request Tracking Prevention
reply_header_access X-Unique-ID             deny all
reply_header_access X-Request-ID            deny all
reply_header_access X-Varnish               deny all
reply_header_access X-Served-By             deny all

# Telemetry and Monitoring Blocking
reply_header_access Report-To               deny all
reply_header_access NEL                     deny all
reply_header_access Server-Timing           deny all
reply_header_access Timing-Allow-Origin     deny all

# Backend Infrastructure Hiding
reply_header_access X-Runtime               deny all
reply_header_access X-Backend-Server        deny all
reply_header_access X-Proxy-ID              deny all
reply_header_access X-SourceMap             deny all
reply_header_access SourceMap               deny all

# Protocol Hint Blocking
reply_header_access Alt-Svc                 deny all
reply_header_access Alternate-Protocol      deny all
reply_header_access Public-Key-Pins         deny all
reply_header_access Expect-CT               deny all

# Allow everything else — Set-Cookie, ETag, Last-Modified needed for:
# - Session management (login/authentication)
# - Cache validation (HTTP 304 Not Modified)
# - Normal website functionality
reply_header_access All allow all

#################################################################
# TIMEOUT CONFIGURATION
#################################################################
# Tightened for modern broadband — reduce resource waste
forward_timeout              90 seconds
connect_timeout              30 seconds
read_timeout                 90 seconds
request_timeout              30 seconds
persistent_request_timeout   65 seconds
client_lifetime              30 minutes
pconn_timeout                65 seconds
shutdown_lifetime            1 second
half_closed_clients          off
detect_broken_pconn          on

#################################################################
# RETRY AND ERROR HANDLING
#################################################################
connect_retries 2
forward_max_tries 4
dead_peer_timeout 10 seconds
retry_on_error on

#################################################################
# PROTOCOL RESTRICTIONS
#################################################################
icp_port 0
htcp_port 0
snmp_port 0
icp_access   deny all
htcp_access  deny all
snmp_access  deny all

#################################################################
# LOGGING
#################################################################
# Default: privacy mode — no logs
access_log none
cache_log  stdio:/dev/null
logfile_rotate 0
strip_query_terms off

# DMT EVICTION DETECTION — uncomment to monitor for DNS cache timing attacks
# Signature: hundreds of unique domains from one client in seconds, all CORS failures
# logformat eviction_detect %>a %ts.%03tu %>rn %Hs %<st %rm %ru
# access_log daemon:/var/log/squid/eviction.log eviction_detect

#################################################################
# PROCESS MANAGEMENT
#################################################################
# OpenBSD: /var/squid/run/squid.pid or /var/run/squid.pid
# Linux:   /var/run/squid.pid or /run/squid.pid
pid_filename /var/run/squid.pid
