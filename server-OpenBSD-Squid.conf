###########################################################################################################################
#                                goal is maximize:       1. increase performance 2. privacy                               #
#                                                                                                                        #
#           OpenBSD Squid config update 2025-11 for OpenBSD                 | upload v. 2025-11-18  |                   #
#######################################################################################################################

########################################################################################################################
# See OpenOCD.md -> replace Wireguard IP with your own | placeholder here are 7.7.7.7/24 port 6666                    #
#######################################################################################################################

http_port                7.7.7.7:6666
tcp_outgoing_address     7.7.7.7
visible_hostname         proxy.local

# Privacy: Hide proxy presence from external sites
via                      off                    # Don't add Via header
forwarded_for            delete                 # Strip client IP from X-Forwarded-For
follow_x_forwarded_for   deny all              # Ignore incoming forwarding headers
httpd_suppress_version_string on               # Hide Squid version

#################################################################
# DNS CONFIGURATION
#################################################################
# Use local resolver for privacy and speed
dns_nameservers          127.0.0.1
dns_defnames             off                    # Don't append domain to hostnames

#################################################################
# WORKER PROCESSES
#################################################################
# Match CPU cores for optimal parallelism (adjust to your system)
# Recommended: 2-8 workers depending on load
workers 4

#################################################################
# RAM-ONLY CACHING STRATEGY
#################################################################
# All caching in memory - zero disk writes for privacy
# Adjust cache_mem based on available RAM (256MB - 2GB typical)
cache_mem                     384 MB
maximum_object_size_in_memory 1 MB             # Don't cache huge objects in RAM
maximum_object_size           0                # Disable disk cache completely
minimum_object_size           0 KB             # Cache everything eligible
memory_cache_shared           on               # Share cache between workers
memory_cache_mode             always           # Always try memory cache first
cache_replacement_policy      heap LFUDA       # Evict least-frequently-used
memory_replacement_policy     heap GDSF        # Greedy-Dual-Size-Frequency

# Collapse identical concurrent requests into one upstream fetch
collapsed_forwarding on

#################################################################
# CONNECTION OPTIMIZATION
#################################################################
# HTTP pipelining for reduced latency
pipeline_prefetch 2

# Persistent connections for connection reuse
client_persistent_connections  on              # Keep client connections alive
server_persistent_connections  on              # Reuse upstream connections

#################################################################
# DNS CACHING STRATEGY
#################################################################
# Aggressive DNS caching to reduce lookup latency
positive_dns_ttl  6 hours                      # Cache successful lookups
negative_dns_ttl  5 minutes                    # Cache NXDOMAIN responses
negative_ttl      30 seconds                   # Cache other failures briefly

# DNS/IP cache sizing (adjust for your domain count)
fqdncache_size 4096                            # FQDN cache entries
ipcache_size 4096                              # IP address cache entries

#################################################################
# SYSTEM RESOURCES
#################################################################
max_filedescriptors 8192                       # File descriptor limit

#################################################################
# BUFFER CONFIGURATION
#################################################################
# Optimized for modern broadband (adjust for slower connections)
client_request_buffer_max_size 512 KB          # Max request size buffered
request_header_max_size 64 KB                  # Max request header size
reply_header_max_size 64 KB                    # Max response header size

#################################################################
# ABORT OPTIMIZATION
#################################################################
# Minimize wasted bandwidth on client disconnects
quick_abort_min 0 KB                           # Always try to abort early
quick_abort_max 0 KB                           # Abort ASAP on disconnect
quick_abort_pct 95                             # Abort if 95% complete
read_ahead_gap 64 KB                           # Read-ahead buffer

#################################################################
# HTTPS HANDLING
#################################################################
# Tunnel HTTPS without inspection (fast, privacy-preserving)
# Note: Cannot modify HTTPS headers without SSL bumping
on_unsupported_protocol tunnel all

#################################################################
# TRAFFIC PRIORITIZATION
#################################################################
# Prioritize interactive content (web pages, API calls)
acl interactive_mime rep_mime_type text/html
acl interactive_mime rep_mime_type application/json
acl interactive_mime rep_mime_type application/xml
acl interactive_mime rep_mime_type text/plain

# Set TOS bits for QoS (requires OS support)
tcp_outgoing_tos 0x28 interactive_mime

#################################################################
# ACCESS CONTROL LISTS
#################################################################
# Define trusted networks and allowed services
acl localnet     src 7.7.7.0/24                # Your LAN subnet
acl localhost    src 127.0.0.1/32
acl local_dests  dst 7.7.7.0/24                # Don't proxy internal traffic
acl SSL_ports    port 443                      # HTTPS port
acl Safe_ports   port 80 443                   # HTTP and HTTPS only
acl Safe_methods method GET HEAD POST OPTIONS CONNECT

# Bypass proxy for local destinations
always_direct    allow local_dests

#################################################################
# ACCESS RULES
#################################################################
# Security-first approach: deny by default, allow explicitly
http_access allow localhost                    # Allow local access
http_access allow localnet                     # Allow LAN access
http_access deny  !Safe_ports                  # Block unsafe ports
http_access deny  CONNECT !SSL_ports           # Only CONNECT to 443
http_access deny  !Safe_methods                # Block unsafe methods
http_access deny  all                          # Deny everything else

#################################################################
# PRIVACY - REQUEST HEADER FILTERING
#################################################################
# Block headers that leak client identity or enable tracking
# Performance impact: ~0.001ms per request (negligible)

# IP Leak Prevention (CRITICAL)
# Block all headers that could reveal client's real IP
request_header_access X-Forwarded-For           deny all
request_header_access X-Real-IP                 deny all
request_header_access X-Client-IP               deny all
request_header_access CF-Connecting-IP          deny all
request_header_access True-Client-IP            deny all
request_header_access Forwarded                 deny all
request_header_access X-Originating-IP          deny all
request_header_access X-Host                    deny all

# Client Hints Blocking (Anti-Fingerprinting)
# Block modern browser fingerprinting via Client Hints API
request_header_access Accept-CH                 deny all
request_header_access Critical-CH               deny all
request_header_access Save-Data                 deny all
request_header_access Device-Memory             deny all
request_header_access Viewport-Width            deny all
request_header_access Downlink                  deny all
request_header_access RTT                       deny all
request_header_access ECT                       deny all

# User-Agent Client Hints (Chrome 89+)
# Block detailed UA information exposed via new API
request_header_access User-Agent-Full           deny all
request_header_access UA-Platform               deny all
request_header_access UA-Platform-Version       deny all
request_header_access UA-Mobile                 deny all
request_header_access UA-Model                  deny all
request_header_access UA-Arch                   deny all
request_header_access UA-Bitness                deny all
request_header_access UA-Full-Version           deny all
request_header_access UA-Full-Version-List      deny all
request_header_access Sec-CH-UA                 deny all
request_header_access Sec-CH-UA-Mobile          deny all
request_header_access Sec-CH-UA-Platform        deny all
request_header_access Sec-CH-UA-Full-Version-List deny all

# Tracking Vector Blocking
# Block headers used for cross-site tracking
request_header_access Sec-GPC                   deny all  # Global Privacy Control
request_header_access Content-DPR               deny all  # Device Pixel Ratio
request_header_access DPR                       deny all
request_header_access Width                     deny all
request_header_access From                      deny all  # Email address
request_header_access Proxy-Connection          deny all  # Legacy header

# Privacy Signal Blocking
# Block Do Not Track (ironically makes you MORE trackable)
request_header_access DNT                       deny all

# IMPORTANT: Allow all other headers
# This includes User-Agent, Cookie, Referer which are needed for:
# - Normal website functionality (cookies for login/sessions)
# - Bot detection bypass (blocking these triggers bot detection)
# - Cache validation (If-None-Match, Cache-Control)
request_header_access All allow all

#################################################################
# PRIVACY - RESPONSE HEADER FILTERING
#################################################################
# Strip headers that leak server information or enable tracking
# Performance impact: ~0.001ms per response (negligible)

# Server Identity Protection
# Hide server software and version information
reply_header_access Server                  deny all
reply_header_access X-Powered-By            deny all
reply_header_access X-AspNet-Version        deny all
reply_header_access X-AspNetMvc-Version     deny all

# Cache Infrastructure Hiding
# Hide proxy/CDN infrastructure details
reply_header_access X-Cache                 deny all
reply_header_access X-Cache-Lookup          deny all
reply_header_access X-Cache-Hits            deny all
reply_header_access Via                     deny all

# Request Tracking Prevention
# Block unique request identifiers used for tracking
reply_header_access X-Unique-ID             deny all
reply_header_access X-Request-ID            deny all
reply_header_access X-Varnish               deny all
reply_header_access X-Served-By             deny all

# Telemetry and Monitoring Blocking
# Block headers used for performance monitoring and analytics
reply_header_access Report-To               deny all
reply_header_access NEL                     deny all  # Network Error Logging
reply_header_access Server-Timing           deny all
reply_header_access Timing-Allow-Origin     deny all

# Backend Infrastructure Hiding
# Prevent leaking internal architecture details
reply_header_access X-Runtime               deny all
reply_header_access X-Backend-Server        deny all
reply_header_access X-Proxy-ID              deny all
reply_header_access X-SourceMap             deny all
reply_header_access SourceMap               deny all

# Protocol Hint Blocking
# Block protocol upgrade and alternative service hints
reply_header_access Alt-Svc                 deny all
reply_header_access Alternate-Protocol      deny all
reply_header_access Public-Key-Pins         deny all
reply_header_access Expect-CT               deny all

# IMPORTANT: Allow all other response headers
# This includes Set-Cookie, ETag, Last-Modified which are critical for:
# - Session management (login/authentication)
# - Cache validation (HTTP 304 Not Modified)
# - Normal website functionality
reply_header_access All allow all

#################################################################
# TIMEOUT CONFIGURATION
#################################################################
# Optimized for modern broadband connections
# Adjust based on your connection speed and latency

forward_timeout              95 seconds        # Upstream server timeout
connect_timeout              32 seconds        # Connection establishment timeout
read_timeout                 125 seconds       # Data read timeout
request_timeout              35 seconds        # Complete request timeout
persistent_request_timeout   125 seconds       # Keepalive timeout
client_lifetime              48 minutes        # Max client session time
pconn_timeout                125 seconds       # Persistent connection timeout
shutdown_lifetime            1 second          # Graceful shutdown time
half_closed_clients          off               # Don't wait for half-closed
detect_broken_pconn          on                # Detect broken connections

#################################################################
# RETRY AND ERROR HANDLING
#################################################################
# Aggressive retry for transient failures
connect_retries 2                              # Connection retry attempts
forward_max_tries 10                           # Max forwarding attempts
dead_peer_timeout 10 seconds                   # Mark peer dead after timeout
retry_on_error on                              # Retry on errors

#################################################################
# PROTOCOL RESTRICTIONS
#################################################################
# Disable unnecessary protocols for security
icp_port 0                                     # Disable ICP
htcp_port 0                                    # Disable HTCP
snmp_port 0                                    # Disable SNMP
icp_access   deny all
htcp_access  deny all
snmp_access  deny all

#################################################################
# LOGGING CONFIGURATION
#################################################################
# Disable logging for privacy (no activity tracking)
# Re-enable for troubleshooting by pointing to actual files
access_log none                                # No access logs
cache_log   stdio:/dev/null                    # Discard cache logs
logfile_rotate 0                               # No log rotation needed
strip_query_terms off                          # Preserve URLs in logs (if enabled)

#################################################################
# PROCESS MANAGEMENT
#################################################################
# PID file location (adjust for your OS)
# OpenBSD: /var/squid/run/squid.pid
# Linux:   /var/run/squid.pid or /run/squid.pid
pid_filename /var/run/squid.pid
